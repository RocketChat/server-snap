name: rocketchat-server-development
title: Rocket.Chat Server
base: core18
version: 4.1.2
summary: An Open Source Slack Alternative
description: |
  Have your own Slack like online chat, built with Meteor. https://rocket.chat/

epoch: 1*

grade: stable
confinement: strict

plugs:
  network:

apps:
  bash:
    command: bash
  rocketchat-mongo:
    command: bin/start_mongod.sh
    environment: { LC_ALL: C }
    stop-command: bin/stop_mongod.sh
    daemon: forking
    plugs: [network-bind]

  rocketchat-server:
    command: bin/start_rocketchat.sh
    stop-command: bin/stop_rocketchat.sh
    environment:
      DEPLOY_METHOD: snap
      LC_ALL: C
    daemon: simple
    after: [rocketchat-mongo]
    plugs:
      - network-bind
      - removable-media

  rocketchat-caddy:
    command: bin/start_caddy.sh
    environment: { LC_ALL: C }
    daemon: simple
    install-mode: disable
    plugs: [network-bind]

  mongo:
    command: bin/mongo
    environment: { LC_ALL: C }

  backupdb:
    command: bin/backupdb.sh
    environment: { LC_ALL: C }

  restoredb:
    command: bin/restoredb.sh
    environment: { LC_ALL: C }

hooks:
  install: { plugs: [network-bind] }

parts:
  mongodb:
    plugin: dump
    source:
      # - on amd64: https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-ubuntu1804-3.6.23.tgz
      - on amd64: https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-ubuntu1804-4.0.27.tgz
      # - on amd64: https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-ubuntu1804-4.2.17.tgz
      - on arm64: https://fastdl.mongodb.org/linux/mongodb-linux-aarch64-ubuntu1804-3.6.23.tgz
    stage-packages:
      # For the dependecies:
      # https://docs.mongodb.com/manual/tutorial/install-mongodb-on-ubuntu-tarball/#install-mongodb-community-edition
      - libcurl4
      - openssl
      - liblzma5
    filesets:
      excluded:
        - -LICENSE-Community.txt
        - -MPL-2
        - -README
        - -THIRD-PART-NOTICES
        - -THIRD-PARTY-NOTICES.gotools
        - -usr/share
        - -bin/bsondump
        - -bin/install_compass
        - -bin/mongoexport
        - -bin/mongofiles
        - -bin/mongoimport
        - -bin/mongoreplay
        - -bin/mongos
        - -bin/mongostat
        - -bin/mongotop
    stage: [$excluded]

  # mongodb-tools:
  #   plugin: dump
  #   source:
  #     - on amd64: https://fastdl.mongodb.org/tools/db/mongodb-database-tools-ubuntu2004-x86_64-100.5.0.tgz
  #     - on arm64: https://fastdl.mongodb.org/tools/db/mongodb-database-tools-ubuntu2004-arm64-100.5.0.tgz
  #   stage:
  #     - bin/mongodump
  #     - bin/mongorestore

  node:
    plugin: dump
    source:
      - on amd64: https://nodejs.org/download/release/v12.22.7/node-v12.22.7-linux-x64.tar.gz
      - on arm64: https://nodejs.org/download/release/v12.22.7/node-v12.22.7-linux-arm64.tar.gz
    stage:
      - bin
      - include
      - lib

  rocketchat:
    plugin: dump
    source: https://cdn-download.rocket.chat/build/rocket.chat-$SNAPCRAFT_PROJECT_VERSION.tgz
    after: [node]
    build-packages:
      - build-essential
      - on arm64:
          - autoconf
          - automake
          - libtool
    override-build: |
      cd programs/server

      [ "$SNAP_ARCH" = "arm64" ] && rm npm/node_modules/sharp/vendor -rf
      NODE_ENV=production npm i --unsafe-perm

      snapcraftctl build
    filesets:
      excluded:
        - -README
        - -README.md
        - -LICENSE
        # filesets are excluding hidden files
        # BUG - need to fix upstream
        # not a bug, design choice
        - .node_version.txt
        - "*"
    stage: [$excluded]

  caddy2:
    plugin: dump
    source:
      - on amd64: https://github.com/caddyserver/caddy/releases/download/v2.4.3/caddy_2.4.3_linux_amd64.tar.gz
      - on arm64: https://github.com/caddyserver/caddy/releases/download/v2.4.3/caddy_2.4.3_linux_arm64.tar.gz
    organize:
      caddy: bin/caddy2
    filesets:
      excluded:
        - -README.md
        - -LICENSE
    stage: [$excluded]

  caddy1:
    plugin: dump
    source:
      - on amd64: https://github.com/caddyserver/caddy/releases/download/v1.0.4/caddy_v1.0.4_linux_amd64.tar.gz
      - on arm64: https://github.com/caddyserver/caddy/releases/download/v1.0.4/caddy_v1.0.4_linux_arm64.tar.gz
    organize:
      caddy: bin/caddy1
    filesets:
      excluded:
        - -README.md
        - -LICENSE
    stage: [$excluded]

  daemons:
    plugin: dump
    source: "./daemons"
    organize:
      "*": "bin/"

  commands:
    plugin: dump
    source: "./commands"
    organize:
      "*": "bin/"

  script-dependecies:
    plugin: nil
    stage-packages:
      # for hooks::configure::validate_url
      - dnsutils
      # for install::jq
      - jq

  migrations:
    plugin: dump
    source: ./migrations
    organize:
      "*": migrations/

  helpers:
    plugin: dump
    source: ./helpers/
    organize:
      "*": helpers/
